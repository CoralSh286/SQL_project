CREATE VIEW patient_treatment_doctor_view AS
SELECT
    tb.p_id,
    p.p_first_name AS patient_first_name,
    p.p_last_name AS patient_last_name,
    tb.t_id,
    t.name AS treatment_name,
    d.d_id,
    d.d_first_name AS doctor_first_name,
    d.d_last_name AS doctor_last_name
FROM treated_by tb
JOIN patient p ON tb.p_id = p.p_id
JOIN treatment t ON tb.t_id = t.t_id
JOIN performs pf ON t.t_id = pf.t_id
JOIN doctor d ON pf.d_id = d.d_id;


SELECT 
    d_id,
    doctor_first_name,
    doctor_last_name,
    COUNT(DISTINCT p_id) AS total_patients
FROM 
    patient_treatment_doctor_view
GROUP BY 
    d_id, doctor_first_name, doctor_last_name
ORDER BY 
    total_patients DESC;


SELECT 
    treatment_name,
    doctor_first_name,
    doctor_last_name,
    COUNT(*) AS times_given
FROM 
    patient_treatment_doctor_view
GROUP BY 
    treatment_name, doctor_first_name, doctor_last_name
ORDER BY 
    times_given DESC;


DROP VIEW patient_treatment_doctor_view;
